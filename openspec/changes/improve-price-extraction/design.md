# Design: Улучшение извлечения цены с повторной проверкой

## Проблема
Цены на maksmart.ru загружаются динамически через JavaScript. Текущая стратегия:
1. `navigate(product_url)`
2. `wait_for(time=3-5)`
3. `take_screenshot(fullPage=true)`
4. Анализ скриншота на наличие цены

Проблема: 3-5 секунд часто недостаточно для полной загрузки цены, особенно при медленном соединении или высокой нагрузке на сервер.

## Решение: Двойная проверка (Retry Strategy)

### Алгоритм извлечения цены с retry

```
1. navigate(product_url)
2. wait_for(time=5) - первичное ожидание
3. take_screenshot(fullPage=true) - первый скриншот
4. Анализ скриншота на наличие цены
5. ЕСЛИ цена НЕ найдена:
   a. wait_for(time=5) - дополнительное ожидание
   b. take_screenshot(fullPage=true) - повторный скриншот
   c. Повторный анализ на наличие цены
6. ЕСЛИ цена всё ещё не найдена после 2 попыток:
   - Считать что пользователь не авторизован
   - Сохранить товар без цены (поле E пустое)
```

### Преимущества
- Увеличивает шанс успешного извлечения цены при медленной загрузке
- Не увеличивает время выполнения когда цена загружается быстро (retry только при необходимости)
- Сохраняет логику "нет авторизации = нет цены" для случаев когда цена действительно недоступна

### Альтернативные варианты (рассмотрены, но отклонены)

1. **Увеличить время ожидания до 10+ секунд** - неэффективно, замедляет все запросы
2. **Использовать wait_for с селектором цены** - ненадёжно, селектор может меняться
3. **Только один retry с большим таймаутом** - выбран компромисс: 2 попытки по 5 сек

## Изменения в промпте

### Обновить секцию `step_3_extract_details`
Добавить явную стратегию retry для извлечения цены.

### Обновить секцию `error_handling.no_price`
Уточнить алгоритм повторных попыток.

### Обновить `patterns.product_page`
Включить retry-паттерн в описание взаимодействия со страницей товара.

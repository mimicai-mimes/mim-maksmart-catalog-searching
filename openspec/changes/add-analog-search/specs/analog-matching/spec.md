# Specification: Analog Product Search

## ADDED Requirements

### Requirement: Поиск аналогов товаров при отсутствии точного совпадения
Система SHALL искать и сохранять аналоги товаров, если точное совпадение не найдено, с указанием процента совпадения и различий.

#### Scenario: Точное совпадение найдено
- **WHEN** поиск выполнен для товара с техническими характеристиками
- **AND** на маркетплейсе найден товар с 95%+ совпадением характеристик
- **THEN** система MUST сохранить товар в Слот 1 со статусом "1:1 совпадение"
- **AND** Слоты 2-3 SHALL оставить пустыми
- **AND** поиск завершить (без поиска аналогов)

#### Scenario: Точного совпадения нет, есть аналоги
- **WHEN** точное совпадение не найдено
- **AND** существуют товары с 60%+ совпадением характеристик
- **THEN** система SHALL выполнить STAGE 2 - поиск аналогов
- **AND** сортировать аналоги по релевантности (75%+, 60-74%)
- **AND** сохранить лучшие в Слоты 1, 2, 3 с указанием процента совпадения
- **AND** указать какие характеристики различаются (например "размер -20мм")

#### Scenario: Ничего не найдено даже аналогов
- **WHEN** поиск выполнен с применением retry (до 3 попыток)
- **AND** не найдено ни точных совпадений ни аналогов (60%+)
- **THEN** система MUST сохранить "не найдено" в Слот 1
- **AND** Слоты 2-3 оставить пустыми

### Requirement: Структура сохранения результатов с поддержкой аналогов
Система SHALL поддерживать сохранение до 3 вариантов товаров (основной + 2 аналога) с метаданными о совпадении.

#### Scenario: Сохранение одного результата
- **WHEN** найдено одно совпадение (точное или аналог 75%+)
- **THEN** система MUST заполнить только Слот 1 (колонки C, D, E, F)
- **AND** Слоты 2-3 оставить пустыми

#### Scenario: Сохранение нескольких результатов
- **WHEN** найдено несколько релевантных вариантов (75%+, 60-74%)
- **THEN** система MUST распределить их по Слотам 1-3
- **AND** Слот 1 содержит лучший результат (точное совпадение или аналог 75%+)
- **AND** Слот 2 содержит второй по релевантности
- **AND** Слот 3 содержит третий по релевантности

## MODIFIED Requirements

### Requirement: Алгоритм поиска товаров
Система SHALL использовать двухуровневый алгоритм: сначала STAGE 1 (точное совпадение), затем STAGE 2 (аналоги).

#### Scenario: Полный workflow с поддержкой аналогов
- **WHEN** начинается поиск товара
- **THEN** система MUST выполнить STAGE 1:
  1. Поиск с исходным названием
  2. Фильтр: характеристики 100% совпадают
  3. Если найдено → сохранить в Слот 1, СТОП
- **THEN** STAGE 2 (если STAGE 1 пусто):
  1. Поиск с исходным названием
  2. Фильтр: характеристики 60-94% совпадают
  3. Если найдено → сортировать по релевантности → сохранить в Слоты 1-3
- **THEN** STAGE 3 (если Слот 1 всё ещё пуст):
  1. Retry: модифицированный запрос
  2. Повторить STAGE 1-2
  3. Если ничего → сохранить "не найдено"

### Requirement: Валидация и сортировка аналогов
Система SHALL корректно определять процент совпадения и сортировать результаты по релевантности.

#### Scenario: Расчет процента совпадения
- **WHEN** сравниваются два товара
- **THEN** система MUST рассчитать совпадение как:
  - Критические характеристики: вес 70% (размеры, диаметры, модели)
  - Название: вес 30%
  - Итоговый % = (критические_совпадение × 0.7) + (название_совпадение × 0.3)
- **AND** указать какие характеристики различаются (например "диаметр -1мм", "название 65%")

#### Scenario: Сортировка по релевантности
- **WHEN** найдено несколько аналогов
- **THEN** система MUST сортировать в порядке убывания релевантности:
  1. 95%+ (точное совпадение)
  2. 75-94% (хорошие аналоги)
  3. 60-74% (приемлемые аналоги)
- **AND** внутри каждой категории сортировать по названию сверху

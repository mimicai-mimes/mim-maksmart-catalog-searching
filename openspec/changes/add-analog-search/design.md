# Design: Поддержка поиска аналогов товаров

## Проблема
Текущая система требует 100% совпадения технических характеристик, что часто невозможно. Пользователи нуждаются в:
- Точном совпадении (1:1)
- Аналогах (60-90% совпадение с указанием различий)

## Решение: Двухуровневый поиск с сохранением аналогов

### Архитектура результатов

Вместо одного результата (C, D, E), система теперь сохраняет:
- **Слот 1 (C, D, E, F)**: Основной результат (точное совпадение или лучший аналог)
- **Слот 2 (G, H, I, J)**: Альтернативный результат (аналог)
- **Слот 3 (K, L, M, N)**: Еще один аналог (если найдено)

Каждый слот содержит:
- Ссылка на товар / "не найдено"
- Название с сайта
- Цена
- Статус совпадения (1:1, аналог с %, или пусто)

### Алгоритм поиска (обновленный)

```
1. Поиск на maksmart.ru с исходным названием
2. STAGE 1: Ищем ТОЧНОЕ СОВПАДЕНИЕ (100% характеристики)
   - Если найдено → сохраняем в Слот 1, СТОП
3. STAGE 2: Ищем АНАЛОГИ (60-90% совпадение характеристик)
   - Найдено несколько вариантов? Сортируем по релевантности
   - Сохраняем лучшие в Слоты 1, 2, 3 (если найдено несколько)
   - Указываем процент совпадения и разницу в каждом слоте
4. STAGE 3: RETRY со модифицированным запросом (если ничего не найдено)
   - Упрощаем запрос → повторяем этапы 1-2
```

### Новая структура колонок

**Слот 1 (основной результат):**
- C: URL товара или "не найдено"
- D: Название с сайта
- E: Цена
- F: Статус совпадения (1:1 / аналог 85% / пусто)

**Слот 2 (альтернатива):**
- G: URL товара или пусто
- H: Название с сайта или пусто
- I: Цена или пусто
- J: Статус совпадения или пусто

**Слот 3 (еще альтернатива):**
- K: URL товара или пусто
- L: Название с сайта или пусто
- M: Цена или пусто
- N: Статус совпадения или пусто

### Критерии сортировки результатов

1. **Точное совпадение (95-100%)** → Слот 1
   - Все критические характеристики совпадают
   - Название совпадает на 80%+ 

2. **Хорошие аналоги (75-94%)** → Слот 1 (если нет точного) или Слот 2
   - 1-2 отличаются в характеристиках, но несущественно
   - Название совпадает на 60%+
   
3. **Приемлемые аналоги (60-74%)** → Слот 2 или 3
   - Больше различий, но общее назначение совпадает
   - Название совпадает на 50%+

### Примеры новой логики

**Сценарий 1: Точное совпадение есть**
```
Ищу: Болт М6х20 DIN 933
Найдено: Болт М6х20 DIN 933 оцинкованный
→ Слот 1: ссылка, название, цена, статус "1:1 совпадение"
→ Слоты 2, 3: пусто
```

**Сценарий 2: Точного нет, есть аналог**
```
Ищу: Гвоздь 5х100 стальной
Найдено:
  - Гвоздь 5х100 (обычный) - 90% совпадение ✓
  - Гвоздь 5х80 - 75% совпадение
  - Гвоздь 4х100 - 60% совпадение
→ Слот 1: 5х100, статус "90% (точный размер)"
→ Слот 2: 5х80, статус "75% (размер -20мм)"
→ Слот 3: 4х100, статус "60% (диаметр -1мм)"
```

**Сценарий 3: Ничего не найдено даже аналогов**
```
Ищу: Редкий товар XYZ
Найдено: Нет вообще
→ Слот 1: "не найдено", остальное пусто
→ Слоты 2, 3: пусто
```

## Изменения в промпте

1. Обновить секцию `data_schema` - описать новую структуру с аналогами
2. Обновить `step_2_analyze_results` - добавить STAGE 2 для поиска аналогов
3. Обновить `step_4_save` - сохранять результаты в нескольких слотах
4. Добавить `matching_algorithm_with_analogs` - расширенный алгоритм
5. Обновить `final_validation_checklist` - проверка аналогов
